<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Music Request SSE í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .status {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .events {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 20px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .event {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
        border-radius: 3px;
      }
      .event-type {
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
      }
      .event-time {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 10px;
      }
      .event-data {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9em;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .controls {
        text-align: center;
        margin: 20px 0;
      }
      .room-info {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid #007bff;
      }
      .music-list {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }
      .music-item {
        background: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
        border: 1px solid #dee2e6;
      }
      .input-group {
        margin: 15px 0;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 14px;
      }
      .room-id-input {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸµ Music Request SSE í…ŒìŠ¤íŠ¸</h1>

      <div class="input-group">
        <label for="roomId">Room ID:</label>
        <input
          type="text"
          id="roomId"
          class="room-id-input"
          value="81a0852c-196a-4f24-8a86-509348963e43"
          placeholder="ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        />
      </div>

      <div class="controls">
        <button id="connectBtn" onclick="connectSSE()">ğŸ”Œ SSE ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnectSSE()" disabled>
          âŒ ì—°ê²° í•´ì œ
        </button>
        <button onclick="clearEvents()">ğŸ—‘ï¸ ì´ë²¤íŠ¸ ì§€ìš°ê¸°</button>
        <button onclick="addTestMusic()">â• í…ŒìŠ¤íŠ¸ ìŒì•… ì¶”ê°€</button>
      </div>

      <div id="status" class="status disconnected">ğŸ”´ SSE ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>

      <div class="room-info">
        <h3>ğŸ  ë°© ì •ë³´</h3>
        <div id="roomInfo">ì—°ê²° í›„ ë°© ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

      <div class="music-list">
        <h3>ğŸµ ìŒì•… ëª©ë¡</h3>
        <div id="musicList">ì—°ê²° í›„ ìŒì•… ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

      <div class="events">
        <h3>ğŸ“¡ ì´ë²¤íŠ¸ ë¡œê·¸</h3>
        <div id="eventsList"></div>
      </div>
    </div>

    <script>
      let eventSource = null;
      let eventCount = 0;
      let currentRoomId = '';

      function connectSSE() {
        if (eventSource) {
          eventSource.close();
        }

        currentRoomId = document.getElementById('roomId').value.trim();
        if (!currentRoomId) {
          alert('Room IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          const url = `http://localhost:8080/music-request/sse?roomId=${currentRoomId}`;
          eventSource = new EventSource(url);

          eventSource.onopen = function (event) {
            updateStatus('ğŸŸ¢ SSE ì—°ê²°ë¨', 'connected');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            addEvent(
              'ì—°ê²°',
              `Room ${currentRoomId}ì— SSE ì—°ê²°ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.`,
              event,
            );
          };

          eventSource.onmessage = function (event) {
            addEvent('ë©”ì‹œì§€', event.data, event);
            updateRoomDisplay(event.data);
          };

          eventSource.onerror = function (event) {
            updateStatus('ğŸ”´ SSE ì—°ê²° ì˜¤ë¥˜', 'disconnected');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            addEvent('ì˜¤ë¥˜', 'SSE ì—°ê²°ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', event);
          };
        } catch (error) {
          console.error('SSE ì—°ê²° ì‹¤íŒ¨:', error);
          addEvent('ì˜¤ë¥˜', 'SSE ì—°ê²°ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      function disconnectSSE() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          updateStatus('ğŸ”´ SSE ì—°ê²° í•´ì œë¨', 'disconnected');
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          addEvent('ì—°ê²° í•´ì œ', 'SSE ì—°ê²°ì´ ìˆ˜ë™ìœ¼ë¡œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }

      function updateStatus(message, className) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${className}`;
      }

      function addEvent(type, data, event = null) {
        eventCount++;
        const eventsList = document.getElementById('eventsList');
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';

        const timestamp = new Date().toLocaleTimeString();
        let displayData = data;

        try {
          // JSON ë°ì´í„°ì¸ ê²½ìš° íŒŒì‹± ì‹œë„
          const parsed = JSON.parse(data);
          displayData = JSON.stringify(parsed, null, 2);
        } catch (e) {
          // JSONì´ ì•„ë‹Œ ê²½ìš° ê·¸ëŒ€ë¡œ í‘œì‹œ
        }

        eventDiv.innerHTML = `
          <div class="event-type">${type}</div>
          <div class="event-time">${timestamp} (ì´ë²¤íŠ¸ #${eventCount})</div>
          <div class="event-data">${displayData}</div>
        `;

        eventsList.appendChild(eventDiv);
        eventsList.scrollTop = eventsList.scrollHeight;
      }

      function updateRoomDisplay(data) {
        try {
          const parsed = JSON.parse(data);

          if (parsed.type === 'room-update') {
            // ë°© ì •ë³´ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
            document.getElementById('roomInfo').innerHTML = `
              <strong>ë°© ID:</strong> ${parsed.roomId}<br>
              <strong>ë°© ì œëª©:</strong> ${parsed.roomTitle}<br>
              <strong>ìŒì•… ìˆ˜:</strong> ${parsed.musicList.length}ê³¡<br>
              <strong>í•™ìƒ ìˆ˜:</strong> ${parsed.studentList.length}ëª…<br>
              <strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> ${new Date(parsed.timestamp).toLocaleString()}
            `;

            // ìŒì•… ëª©ë¡ ì—…ë°ì´íŠ¸
            if (parsed.musicList && parsed.musicList.length > 0) {
              const musicListHtml = parsed.musicList
                .map(
                  (music) => `
                  <div class="music-item">
                    <strong>${music.title}</strong> - ${music.artist || 'Unknown Artist'}<br>
                    <small>ìš”ì²­ì: ${music.requestedBy || music.studentName || 'Unknown'}</small>
                  </div>
                `,
                )
                .join('');
              document.getElementById('musicList').innerHTML = musicListHtml;
            } else {
              document.getElementById('musicList').innerHTML =
                'ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.';
            }

            addEvent(
              'ë°© ì •ë³´ ì—…ë°ì´íŠ¸',
              `ë°© ${parsed.roomId}ì˜ ì •ë³´ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. (${parsed.musicList.length}ê³¡)`,
            );
          } else if (parsed.type === 'new-music') {
            // ìƒˆ ìŒì•… ì¶”ê°€ ì´ë²¤íŠ¸
            addEvent(
              'ìƒˆ ìŒì•…',
              `ìƒˆ ìŒì•…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ${parsed.musicList.title || parsed.music.title}`,
            );

            // ë°© ì •ë³´ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
              if (eventSource && eventSource.readyState === EventSource.OPEN) {
                addEvent('ì •ë³´', 'ë°© ì •ë³´ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...');
              }
            }, 1000);
          } else if (parsed.type === 'deleted-music') {
            // ìŒì•… ì œê±° ì´ë²¤íŠ¸
            addEvent('ìŒì•… ì œê±°', `ìŒì•…ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤: ${parsed.musicId}`);
          } else if (parsed.type === 'ping') {
            // ping ì´ë²¤íŠ¸
            addEvent(
              'Ping',
              `ì—°ê²° ìƒíƒœ í™•ì¸ - Room ${parsed.roomId} (${new Date(parsed.timestamp).toLocaleTimeString()})`,
            );
          } else if (parsed.type === 'error') {
            // ì—ëŸ¬ ì´ë²¤íŠ¸
            addEvent('ì—ëŸ¬', parsed.message);
          }
        } catch (e) {
          console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
        }
      }

      function clearEvents() {
        document.getElementById('eventsList').innerHTML = '';
        eventCount = 0;
      }

      async function addTestMusic() {
        if (!currentRoomId) {
          alert('ë¨¼ì € SSEì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:8080/music-request/room/${currentRoomId}/music`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                musicId: `test_${Date.now()}`,
                title: `í…ŒìŠ¤íŠ¸ ìŒì•… ${Date.now()}`,
                student: 'í…ŒìŠ¤íŠ¸ í•™ìƒ',
              }),
            },
          );

          if (response.ok) {
            addEvent('í…ŒìŠ¤íŠ¸', 'í…ŒìŠ¤íŠ¸ ìŒì•…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            addEvent('ì˜¤ë¥˜', 'í…ŒìŠ¤íŠ¸ ìŒì•… ì¶”ê°€ ì‹¤íŒ¨');
          }
        } catch (error) {
          addEvent('ì˜¤ë¥˜', 'í…ŒìŠ¤íŠ¸ ìŒì•… ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: ' + error.message);
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
      window.onload = function () {
        updateStatus('ğŸ”´ SSE ì—°ê²°ë˜ì§€ ì•ŠìŒ', 'disconnected');
      };

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì •ë¦¬
      window.onbeforeunload = function () {
        if (eventSource) {
          eventSource.close();
        }
      };
    </script>
  </body>
</html>
